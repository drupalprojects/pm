<?php
/**
 * @file
 * Test definitions for PM Permission.
 */

/**
 * Define a test case for PM Permission.
 */
class PmpermissionTestCase extends DrupalWebTestCase {

  /**
   * Returns meta data for PM Permission tests.
   */
  public static function getInfo() {
    return array(
      'name' => 'PM Permission functionality',
      'description' => 'Test the functionality of PM Permission.',
      'group' => 'Project Management',
    );
  }

  /**
   * Standard set up for all tests.
   */
  public function setUp() {
    parent::setUp('pm', 'pmpermission', 'pmorganization', 'pmproject');
    node_access_rebuild();
  }

  /**
   * Tests "view all" permission.
   */
  public function testpmpermissionViewAll() {
    // Allow PM Permission to override organization permissions.
    variable_set('node_permissions_pmorganization', 0);

    // Create a node to test against.
    $organization_settings = array(
      'type' => 'pmorganization',
    );
    $organization = $this->drupalCreateNode($organization_settings);
    $this->assertTrue(isset($organization->nid), 'Node successfully created.');

    // Test that anonymous users can not view the node.
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(403, 'Access is denied to anonymous user.');

    // Create basic user and test that user cannot view the node.
    $basic_user = $this->drupalCreateUser(array());
    $this->assertTrue(is_object($basic_user), 'Basic user successfully created.');
    
    $this->drupalLogin($basic_user);
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(403, 'Access is denied to basic user.');

    // Investigate test failure by checking via node_access().
    $access = node_access('view', $organization, $basic_user);
    $this->assertTrue($access == FALSE, 'Basic user access denied'); 
    
    // Create user and test that user can view the node.
    $user_permissions = array(
      'PM permission pmorganization: view all',
    );
    $this->checkPermissions($user_permissions, TRUE);

    $user = $this->drupalCreateUser($user_permissions);
    $this->assertTrue(is_object($user), 'User successfully created.');
    
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(200, 'Access granted to user.');
 }

  /**
   * Tests "belonged" permission.
   */
  public function testpmpermissionBelonged() {
    // Allow PM Permission to override organization permissions.
    variable_set('node_permissions_pmorganization', 0);

    // Create two users for testing view permissions (A & B).
    $user_permissions = array(
      'PM permission pmorganization: view own Organization',
    );
    $this->checkPermissions($user_permissions, TRUE);

    $user_a = $this->drupalCreateUser($user_permissions);
    $user_b = $this->drupalCreateUser($user_permissions);
    $this->assertTrue(is_object($user_a), 'User A successfully created.');
    $this->assertTrue(is_object($user_b), 'User B successfully created.');

    // Create a node to test against.
    $organization_settings = array(
      'type' => 'pmorganization',
      'pmorganization_members' => $user_b->uid,
    );
    $organization = $this->drupalCreateNode($organization_settings);
    $this->assertTrue(isset($organization->nid), 'Node successfully created.');

    // Test that anonymous users can not view the node.
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(403, 'Access is denied to anonymous user.');

    // Test that user A can not view the node.
    $this->drupalLogin($user_a);
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(403, 'Access is denied to user A.');

    // Test that user B can view the node.
    $this->drupalLogin($user_b);
    $this->drupalGet('node/' . $organization->nid);
    $this->assertResponse(200, 'Access granted to user B.');
  }

  /**
   * Tests permissions after parent change.
   */
  public function testpmpermissionChangeParent() {
    // Enable modules required only for this test.
    $modules = array(
      'pmorganization',
      'pmproject',
    );
    $result = module_enable($modules, TRUE);
    $this->AssertTrue($result, 'Modules were enabled successfully.');

    $this->resetAll();
    drupal_cron_run();

    // Allow PM Permission to override project permissions.
    variable_set('node_permissions_pmproject', 0);

    // Create one user to author nodes.
    $author_permissions = array(
      'create pmorganization content',
      'PM permission pmproject: create',
      'PM permission pmproject: update all',
    );
    $this->checkPermissions($author_permissions, TRUE);
    $author = $this->drupalCreateUser($author_permissions);
    $this->assertTrue(is_object($author), 'Author user successfully created.');

    // Create two users for testing view permissions (A & B).
    $user_permissions = array(
      'PM permission pmproject: view own Organization',
    );
    $this->checkPermissions($user_permissions, TRUE);
    $user_a = $this->drupalCreateUser($user_permissions);
    $user_b = $this->drupalCreateUser($user_permissions);
    $this->assertTrue(is_object($user_a), 'User A successfully created.');
    $this->assertTrue(is_object($user_b), 'User B successfully created.');

    // Create two organization nodes (A & B) with respective users as members.
    $this->drupalLogin($author);

    $organization_a_settings = array(
      'type' => 'pmorganization',
      'pmorganization_members' => $user_a->uid,
    );
    $organization_a = $this->drupalCreateNode($organization_a_settings);

    $organization_b_settings = array(
      'type' => 'pmorganization',
      'pmorganization_members' => $user_b->uid,
    );
    $organization_b = $this->drupalCreateNode($organization_b_settings);

    // Create one project node, attached to organization A.
    $project_settings = array(
      'type' => 'pmproject',
      'pmproject_parent' => $organization_a->nid,
    );
    $project = $this->drupalCreateNode($project_settings);

    // Test that user A can view the project.
    $this->drupalLogin($user_a);
    $this->drupalGet('node/' . $project->nid);
    $this->assertResponse(200, 'Access granted to user A when project is attached to organization A.');

    // Test that user B can not view the project.
    $this->drupalLogin($user_b);
    $this->drupalGet('node/' . $project->nid);
    $this->assertResponse(403, 'Access is denied to user B when project is attached to organization A.');

    // Attach the project to organization B.
    $this->drupalLogin($author);
    $project->pmproject_parent = $organization_b->nid;
    node_save($project);

    // Test that user A can not view the project.
    $this->drupalLogin($user_a);
    $this->drupalGet('node/' . $project->nid);
    $this->assertResponse(403, 'Access is denied to user A when project is attached to organization B.');

    // Test that user B can view the project.
    $this->drupalLogin($user_b);
    $this->drupalGet('node/' . $project->nid);
    $this->assertResponse(200, 'Access granted to user B when project is attached to organization B.');
  }

  /**
   * Tests module uninstall path.
   */
  public function testpmpermissionUninstall() {
    $module = array('pmpermission');

    module_disable($module);
    $result = drupal_uninstall_modules($module);
    $this->AssertTrue($result, t('Module successfully uninstalled.'));
  }

}